FROM alpine

RUN  sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \
   && apk update \
   && apk add nodejs-current npm g++ git python3 make \
   && echo 'https://dl-cdn.alpinelinux.org/alpine/v3.9/main' >> /etc/apk/repositories \
   && echo 'https://dl-cdn.alpinelinux.org/alpine/v3.9/community' >> /etc/apk/repositories \
   && sed -i 's/dl-cdn.alpinelinux.org/mirrors.tuna.tsinghua.edu.cn/g' /etc/apk/repositories \
   && apk update \
   && apk add mongodb yaml-cpp=0.6.2-r2 \
   && git clone --depth=1 https://hub.fastgit.xyz/Crepe-Inc/CrepeSR.git \
   && git clone https://hub.fastgit.xyz/memetrollsXD/CrepeSR-Resources.git /CrepeSR/src/data \
   && cd /CrepeSR \
   && npm --registry=https://registry.npmmirror.com install \
   && apk del g++ git python3 make \
   && rm -r /CrepeSR/src/data/StarRail_Data \
   && mkdir -v /CrepeSR/db \
   && echo "cd /CrepeSR && mongod --fork --quiet --dbpath=/CrepeSR/db --syslog && npm run start" > /CrepeSR/run.sh

ENTRYPOINT [ "/bin/sh" , "/CrepeSR/run.sh" ]
